VERSION 0.6
FROM golang:1.15-alpine3.13
WORKDIR /activity-log

RUN apk add build-base

deps:
    COPY go.mod go.sum ./
    RUN go mod download
    RUN go get github.com/mattn/go-sqlite3
    SAVE ARTIFACT go.mod AS LOCAL go.mod
    SAVE ARTIFACT go.sum AS LOCAL go.sum

build:
    FROM +deps
    COPY . .
    RUN go build -o build/activity-log cmd/server/main.go
    SAVE ARTIFACT build/activity-log /activity-log 

docker:
    COPY +build/activity-log .
    ENTRYPOINT ["/activity-log/activity-log"]
    EXPOSE 8080
    SAVE IMAGE --push agbell/cloudservices/activity-log

grpcurl:
    FROM fullstorydev/grpcurl:latest
    SAVE ARTIFACT /bin/grpcurl ./grpcurl

test-deps:
    FROM earthly/dind
    RUN apk add curl jq
    COPY +grpcurl/grpcurl /bin/grpcurl

test:
    FROM +test-deps
    COPY test.sh .
    WITH DOCKER --load agbell/cloudservices/activity-log=+docker
        RUN  docker run -d -p 8080:8080 agbell/cloudservices/activity-log && \
                ./test.sh
    END

export:
    COPY go.mod go.sum ./
    COPY api ./api
    SAVE ARTIFACT /activity-log